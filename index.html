<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡è´¦å• PDF è½¬ Excel å·¥å…· - å®‰å…¨éšç§ï¼Œæœ¬åœ°æé€Ÿè½¬æ¢</title>
    <meta name="keywords" content="å¾®ä¿¡è´¦å•å¯¼å‡º, å¾®ä¿¡è´¦å•è½¬Excel, PDFè½¬Excel, å¾®ä¿¡æ”¯ä»˜æµæ°´, è´¦å•åˆ†æ, è®°è´¦å·¥å…·, éšç§ä¿æŠ¤, æœ¬åœ°è¿è¡Œ, å¾®ä¿¡å¯¹è´¦å•æ ¼å¼è½¬æ¢">
    <meta name="description" content="ä¸€æ¬¾å®‰å…¨å¯é çš„å¾®ä¿¡è´¦å•è½¬æ¢å·¥å…·ï¼Œåœ¨æµè§ˆå™¨æœ¬åœ°å°†å¾®ä¿¡ PDF è´¦å•è½¬æ¢ä¸º Excel (.xlsx) æ ¼å¼ã€‚æ‰€æœ‰æ•°æ®ä»…åœ¨æ‚¨è®¾å¤‡ä¸Šå¤„ç†ï¼Œç»ä¸ä¸Šä¼ æœåŠ¡å™¨ï¼Œä¿éšœæ‚¨çš„éšç§å®‰å…¨ã€‚æ”¯æŒæ‰¹é‡è½¬æ¢ï¼Œç®€å•æ˜“ç”¨ã€‚">
    <!-- 
        å…³äºä¸­å›½å¤§é™†è®¿é—®é€Ÿåº¦ï¼š
        jsdelivr åœ¨å›½å†…è®¿é—®å¯èƒ½ä¸ç¨³å®šã€‚
        å¦‚æœéœ€è¦æé€Ÿä½“éªŒæˆ–ç¦»çº¿ä½¿ç”¨ï¼Œè¯·è®¿é—® https://github.com/pyodide/pyodide/releases 
        ä¸‹è½½ pyodide-build-0.25.0.tar.bz2ï¼Œè§£å‹åæ”¾åœ¨æœ¬åœ°ç›®å½•ï¼Œ
        ç„¶åå°†ä¸‹æ–¹çš„ src ä¿®æ”¹ä¸ºæœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚ src="./pyodide/pyodide.js"
    -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            min-height: 100vh; /* ç¡®ä¿ body æ’‘æ»¡å±å¹•ä»¥å“åº”æ‹–æ‹½ */
            display: flex;
            flex-direction: column;
        }
        h1 {
            border-bottom: 2px solid #07c160;
            padding-bottom: 10px;
            color: #333;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        /* æ‹–æ‹½åŒºåŸŸæ ·å¼ */
        .drop-zone {
            border: 2px dashed #07c160;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f0fdf4;
            color: #555;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        @media (max-width: 600px) {
            .drop-zone {
                padding: 20px 10px;
            }
            .drop-zone .icon {
                font-size: 32px;
            }
            .drop-zone p {
                font-size: 16px !important;
            }
             h1 {
                font-size: 24px;
            }
        }
        .drop-zone:hover {
            background-color: #e1fcef;
            border-color: #06ad56;
        }
        .drop-zone.dragover {
            background-color: #d1fae5;
            transform: scale(1.01);
            border-color: #059669;
            box-shadow: 0 0 10px rgba(7, 193, 96, 0.2);
        }
        .drop-zone .icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        .drop-zone p {
            margin: 5px 0;
        }
        .drop-zone .hint {
            font-size: 13px;
            color: #888;
        }
        
        /* éšè—åŸå§‹ input */
        #fileInput {
            display: none;
        }
        
        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-list {
            text-align: left;
            margin-top: 15px;
            background: #fff;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #eee;
            display: none; /* é»˜è®¤éšè— */
        }
        .file-item {
            display: flex;
            align-items: flex-start; /* é•¿æ–‡ä»¶åæ¢è¡Œæ—¶ï¼Œå›¾æ ‡ä¿æŒé¡¶éƒ¨å¯¹é½ */
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
            line-height: 1.4;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item .file-icon {
            margin-right: 8px;
            flex-shrink: 0; /* é˜²æ­¢å›¾æ ‡è¢«å‹ç¼© */
            margin-top: 2px; /* å¾®è°ƒå›¾æ ‡ä½ç½® */
        }
        .file-item .file-name {
            flex: 1;       /* å æ®å‰©ä½™ç©ºé—´ */
            word-break: break-all; /* å…è®¸åœ¨ä»»æ„å­—ç¬¦é—´æ¢è¡Œï¼Œé˜²æ­¢é•¿æ–‡ä»¶åæº¢å‡º */
            min-width: 0;  /* Flex item æº¢å‡ºä¿®å¤ */
        }
        .file-item .file-size {
            color: #aaa;
            margin-left: 8px;
            font-size: 12px;
            white-space: nowrap; /* å¤§å°ä¿¡æ¯ä¸æ¢è¡Œ */
            flex-shrink: 0;
        }
        
        button {
            background-color: #07c160;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block;
            width: 100%;
        }
        button:hover {
            background-color: #06ad56;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 100px;
            overflow-y: auto;          /* å…è®¸çºµå‘æ»šåŠ¨ */
            max-height: 300px;         /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        #status .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
            word-wrap: break-word;   /* ç¡®ä¿é•¿æ–‡æœ¬æ¢è¡Œ */
            white-space: pre-wrap;   /* ä¿ç•™æ¯æ¡æ—¥å¿—å†…éƒ¨çš„æ ¼å¼ï¼ˆå¦‚ Tracebackï¼‰ */
        }
        #status .log-entry:last-child {
            border-bottom: none;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        .warning {
            color: #e6a23c;
            font-size: 12px;
            margin-top: 5px;
        }
        .help-link {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        .help-link a {
            color: #07c160;
            text-decoration: none;
            border-bottom: 1px dashed #07c160;
        }
        .help-link a:hover {
            border-bottom-style: solid;
        }
        .footer {
            margin-top: auto; /* å°† footer æ¨åˆ° flex å®¹å™¨çš„æœ€åº•éƒ¨ */
            padding-top: 30px;
            text-align: center;
            font-size: 13px;
            color: #888;
            padding-bottom: 20px;
        }
        .footer a {
            color: #07c160;
            text-decoration: none;
            border-bottom: 1px dashed #07c160;
        }
        .footer a:hover {
            border-bottom-style: solid;
        }
    </style>
</head>
<body>

    <h1>å¾®ä¿¡è´¦å• PDF è½¬ Excel</h1>
    
    <div class="info">
        <p>è¿™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯è¿è¡Œçš„ç‰ˆæœ¬ï¼Œä½¿ç”¨äº† WebAssembly (Pyodide) æŠ€æœ¯ã€‚</p>
        <p>ğŸ”’ <strong>éšç§å®‰å…¨</strong>ï¼šæ‚¨çš„è´¦å•æ–‡ä»¶åªåœ¨æ‚¨çš„æµè§ˆå™¨å†…å¤„ç†ï¼Œ<b>ä¸ä¼š</b>ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
        <p class="warning">âš ï¸ æ³¨æ„ï¼šé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ Python å¼•æ“ (çº¦ 10MB)ï¼Œå¦‚æœä½ åœ¨ä¸­å›½å¤§é™†ï¼ŒåŠ è½½å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…æˆ–å¼€å¯ç½‘ç»œä»£ç†ã€‚</p>
        <p class="help-link">
            ä¸çŸ¥é“å»å“ªé‡Œä¸‹è½½ PDF è´¦å•ï¼Ÿ
            <a href="https://letmegooglethat.com/?q=%E5%A6%82%E4%BD%95%E5%AF%BC%E5%87%BA%E5%BE%AE%E4%BF%A1%E8%B4%A6%E5%8D%95+PDF" target="_blank" title="ç‚¹å‡»æŸ¥çœ‹æœç´¢æ•™ç¨‹">
                ğŸ‘‰ ç‚¹è¿™é‡Œï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•è·å–
            </a>
        </p>
    </div>

    <div class="container">
        <div class="control-group">
            <label>1. é€‰æ‹©å¾®ä¿¡è´¦å• PDF æ–‡ä»¶</label>
            
            <!-- ç¾åŒ–åçš„æ‹–æ‹½åŒºåŸŸ -->
            <div id="dropZone" class="drop-zone" onclick="triggerFileSelect()">
                <span class="icon">ğŸ“„</span>
                <p style="font-size: 18px; font-weight: 500;">ç‚¹å‡»é€‰æ‹© æˆ– æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                <p class="hint">æ”¯æŒæ‹–æ‹½å¤šä¸ª PDF æ–‡ä»¶åˆ°é¡µé¢ä»»æ„ä½ç½®</p>
                
                <!-- æ˜¾ç¤ºå·²é€‰æ–‡ä»¶ -->
                <div id="fileList" class="file-list"></div>
            </div>

            <!-- éšè—çš„åŸå§‹ Input -->
            <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none" onchange="handleFileSelect(this.files)" disabled>
        </div>

        <div class="control-group">
            <button id="convertBtn" onclick="startConversion()" disabled>æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ...</button>
        </div>

        <div class="control-group">
            <label>è¿è¡Œæ—¥å¿—</label>
            <div id="status"><div class="log-entry">æ­£åœ¨ä¸‹è½½ Python è¿è¡Œæ—¶ (çº¦ 10MB)ï¼Œè¯·ç¨å€™...</div></div>
        </div>
    </div>

    <div class="footer">
        <p>ç”± <a href="https://github.com/pyodide/pyodide" target="_blank">Pyodide</a> æä¾›æŠ€æœ¯æ”¯æŒ</p>
        <p>å¼€æºé¡¹ç›®ï¼Œæ¬¢è¿ <a href="https://github.com/Wxh16144/wechat-bills" target="_blank">è´¡çŒ®ä»£ç </a> æˆ– <a href="https://github.com/Wxh16144/wechat-bills/issues" target="_blank">æŠ¥å‘Šé—®é¢˜</a></p>
    </div>

    <script type="text/javascript">
        let pyodide = null;
        let micropip = null;
        const statusDiv = document.getElementById("status");
        const convertBtn = document.getElementById("convertBtn");
        const fileInput = document.getElementById("fileInput");
        const dropZone = document.getElementById("dropZone");
        const fileListDiv = document.getElementById("fileList");

        // --- å…¨å±€æ‹–æ‹½æ”¯æŒ ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            document.body.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        document.body.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFileSelect(files);
        }

        function triggerFileSelect() {
            if (!fileInput.disabled) {
                fileInput.click();
            }
        }

        function handleFileSelect(files) {
             if (fileInput.disabled) return; 
             
             if (files.length > 0) {
                 // ç®€å•çš„æ–‡ä»¶è¿‡æ»¤ï¼šåªä¿ç•™ PDFï¼Œä¸”å°½å¯èƒ½æ’é™¤ç›®å½•(é€šå¸¸ç›®å½• type ä¸ºç©ºä¸” size ç‰¹å®šï¼Œä½†åœ¨ drop æ—¶ä¸å‡†)
                 // æœ€ç®€å•çš„è¿‡æ»¤ï¼šåªçœ‹åç¼€å
                 const validFiles = [];
                 
                 for(let i=0; i<files.length; i++) {
                     const f = files[i];
                     if (f.name.toLowerCase().endsWith('.pdf')) {
                         validFiles.push(f);
                     }
                 }
                 
                 if (validFiles.length < files.length && files.length > 0) {
                     alert("éƒ¨åˆ†æ‹–å…¥çš„å†…å®¹ä¸æ˜¯ PDF æ–‡ä»¶ï¼Œå·²è¢«å¿½ç•¥ã€‚");
                 }
                 
                 if(validFiles.length > 0) {
                     // å°†è¿‡æ»¤åçš„æ–‡ä»¶èµ‹å€¼ç»™ input (éœ€è¦ä½¿ç”¨ DataTransfer)
                     const dt = new DataTransfer();
                     validFiles.forEach(file => dt.items.add(file));
                     fileInput.files = dt.files;
                     
                     updateFileListDisplay(fileInput.files);
                 }
             }
        }

        function updateFileListDisplay(files) {
            if (files.length === 0) {
                fileListDiv.style.display = 'none';
                return;
            }
            fileListDiv.style.display = 'block';
            let html = '<div style="margin-bottom:5px; font-weight:bold;">å·²é€‰æ–‡ä»¶ï¼š</div>';
            for(let i=0; i<files.length; i++) {
                const f = files[i];
                const sizeStr = (f.size / 1024).toFixed(1) + ' KB';
                html += `<div class="file-item">
                    <span class="file-icon">âœ…</span>
                    <span class="file-name">${f.name}</span>
                    <span class="file-size">(${sizeStr})</span>
                </div>`;
            }
            fileListDiv.innerHTML = html;
        }

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = msg;
            statusDiv.appendChild(div);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            statusDiv.scrollTop = statusDiv.scrollHeight;
            console.log(msg);
        }

        async function initPyodideEnv() {
            try {
                pyodide = await loadPyodide();
                log("Python è¿è¡Œæ—¶åŠ è½½æˆåŠŸã€‚");
                
                log("æ­£åœ¨å®‰è£…ä¾èµ–åº“ (micropip, openpyxl, pdfplumber)... è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚");
                await pyodide.loadPackage("micropip");
                micropip = pyodide.pyimport("micropip");

                // å®‰è£… pandas (openpyxl éœ€è¦) å’Œ xml ç›¸å…³
                // pdfplumber ä¾èµ–: pdfminer.six, pillow, wand(å¯é€‰)
                // Pyodide ç¯å¢ƒä¸­é€šå¸¸è‡ªå¸¦ Pillow
                // ä¸€äº›çº¯ Python åŒ…å¯ä»¥ç›´æ¥é€šè¿‡ micropip.install å®‰è£…
                // æ³¨æ„ï¼šæœ€æ–°ç‰ˆ pdfplumber ä¾èµ– pypdfium2 (å«Cæ‰©å±•ï¼Œä¸æ”¯æŒ Pyodide)ï¼Œå› æ­¤é”å®šä½¿ç”¨æ—§ç‰ˆæœ¬ 0.9.0
                
                await micropip.install(['openpyxl', 'pdfplumber==0.9.0']);
                
                log("ä¾èµ–åº“å®‰è£…å®Œæˆï¼è¯·é€‰æ‹©æ–‡ä»¶è¿›è¡Œè½¬æ¢ã€‚");
                convertBtn.innerText = "å¼€å§‹è½¬æ¢";
                convertBtn.disabled = false;
                fileInput.disabled = false;
                // æ›´æ–° UI æç¤º
                const hintP = dropZone.querySelector('.hint');
                if (hintP) hintP.innerText = "ç¯å¢ƒå·²å°±ç»ªï¼Œæ‚¨å¯ä»¥æ‹–æ‹½æ–‡ä»¶äº†";

                // å®šä¹‰ Python å¤„ç†å‡½æ•°
                // è¿™é‡Œçš„ Python ä»£ç æ˜¯åŸºäº WeChatBillsPdf2Xlsx.py æ ¸å¿ƒé€»è¾‘çš„ç®€åŒ–ç‰ˆï¼Œé€‚é… Web ç¯å¢ƒ
                pyodide.runPython(`
import datetime
import pdfplumber
import openpyxl
import os

def process_pdfs(file_paths, output_filename):
    print(f"å¼€å§‹å¤„ç† {len(file_paths)} ä¸ªæ–‡ä»¶...")
    try:
        total_rows = []
        for fi, file_path in enumerate(file_paths):
            print(f"æ­£åœ¨è§£æ: {os.path.basename(file_path)}")
            # Web ç¯å¢ƒä¸‹æ–‡ä»¶ç³»ç»Ÿæ“ä½œä¸æœ¬åœ°ä¸€è‡´
            with pdfplumber.open(file_path) as pdf:
                for pi, page in enumerate(pdf.pages):
                    tables = page.extract_tables()
                    for ti, table in enumerate(tables):
                        # å»é‡é€»è¾‘ï¼šä¿ç•™ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è¡¨å¤´ï¼Œåç»­æ–‡ä»¶å¦‚æœåŒ…å«è¡¨å¤´åˆ™å»é™¤
                        # åŸè„šæœ¬é€»è¾‘ï¼šif fi != 0 and pi == 0 and ti == 0: table = table[3:]
                        if fi != 0 and pi == 0 and ti == 0:
                            table = table[3:]  
                        
                        for row in table:
                            if row and len(row) > 1:
                                # æ¸…ç†æ¢è¡Œç¬¦
                                if row[1] and "\\n" in row[1]:
                                    row[1] = row[1].replace("\\n", " ")
                                row = [col.replace("\\n", "") if col else "" for col in row]
                                total_rows.append(row)
        
        if len(total_rows) < 4:
            return False, "è­¦å‘Š:æ•°æ®è¡Œæ•°ä¸è¶³(å°‘äº4è¡Œ)ï¼Œè¯·ç¡®è®¤ä¸Šä¼ çš„æ˜¯å¾®ä¿¡è´¦å•PDFã€‚"

        # å¤´éƒ¨å¤§æ¦‚åœ¨ç¬¬3è¡Œ(index 2)ï¼Œæ•°æ®ä»ç¬¬4è¡Œ(index 3)å¼€å§‹
        header = total_rows[2]
        data_rows = total_rows[3:]
        
        # æŒ‰æ—¥æœŸæ’åº (index 1)
        data_rows.sort(key=lambda ele: ele[1])

        wb = openpyxl.Workbook()
        sheet = wb.active
        sheet.title = "è´¦å•"
        
        # å†™è¡¨å¤´
        for ci, col in enumerate(header):
            sheet.cell(row=1, column=ci + 1, value=col)
            
        # å†™æ•°æ®
        for ri, row in enumerate(data_rows):
            for ci, col in enumerate(row):
                cell = sheet.cell(row=ri + 2, column=ci + 1, value=col)
                # æ ¼å¼è½¬æ¢
                if ci == 1:  # æ—¥æœŸåˆ—
                    try:
                        cell.value = datetime.datetime.fromisoformat(col)
                        cell.number_format = 'yyyy-mm-dd hh:mm:ss'
                    except:
                        pass
                elif ci == 5:  # é‡‘é¢åˆ—
                    try:
                        cell.value = float(col);
                        cell.number_format = '0.00'
                    except:
                        pass
        
        wb.save(output_filename)
        return True, f"è½¬æ¢æˆåŠŸ! å…± {len(data_rows)} æ¡è®°å½•ã€‚"
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return False, str(e)
                `);

            } catch (err) {
                log("åˆå§‹åŒ–å¤±è´¥: " + err);
                console.error(err);
            }
        }

        async function startConversion() {
            if (!fileInput.files.length) {
                alert("è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶ï¼");
                return;
            }

            convertBtn.disabled = true;
            convertBtn.innerText = "å¤„ç†ä¸­...";
            log("å¼€å§‹è¯»å–æ–‡ä»¶...");

            try {
                // 1. å°†ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å†™å…¥ Pyodide è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                let filePaths = [];
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const virtualPath = "/tmp/" + file.name;
                    pyodide.FS.writeFile(virtualPath, uint8Array);
                    filePaths.push(virtualPath);
                }

                log(`å·²åŠ è½½ ${filePaths.length} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨è°ƒç”¨ Python è½¬ç ...`);

                // 2. è°ƒç”¨ Python å‡½æ•°
                const outputFilename = "wechat_bills_export.xlsx";
                // å°† JS æ•°ç»„è½¬æ¢ä¸º Python åˆ—è¡¨
                const processFunc = pyodide.globals.get("process_pdfs");
                const result = processFunc(pyodide.toPy(filePaths), outputFilename);
                const success = result.get(0);
                const msg = result.get(1);

                log(msg);

                if (success) {
                    // 3. å°†ç”Ÿæˆçš„æ–‡ä»¶ä» Pyodide FS è¯»å› JS å¹¶ä¸‹è½½
                    log("æ­£åœ¨å‡†å¤‡ä¸‹è½½...");
                    const fileContent = pyodide.FS.readFile(outputFilename);
                    const blob = new Blob([fileContent], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `å¾®ä¿¡è´¦å•å¯¼å‡º_${new Date().toISOString().slice(0,19).replace(/[-:T]/g,"")}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log("ä¸‹è½½å·²è§¦å‘ã€‚");
                    
                    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    try {
                        pyodide.FS.unlink(outputFilename);
                        filePaths.forEach(p => pyodide.FS.unlink(p));
                    } catch(e) {}
                }

            } catch (err) {
                log("å¤„ç†è¿‡ç¨‹å‡ºé”™: " + err);
                console.error(err);
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerText = "å¼€å§‹è½¬æ¢";
            }
        }

        // å¯åŠ¨åŠ è½½
        initPyodideEnv();

    </script>
</body>
</html>
