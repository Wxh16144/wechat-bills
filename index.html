<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡è´¦å• PDF è½¬ Excel (çº¯å‰ç«¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            border-bottom: 2px solid #07c160;
            padding-bottom: 10px;
            color: #333;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        button {
            background-color: #07c160;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #06ad56;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .info {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h1>å¾®ä¿¡è´¦å• PDF è½¬ Excel</h1>
    
    <div class="info">
        <p>è¿™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯è¿è¡Œçš„ç‰ˆæœ¬ï¼Œä½¿ç”¨äº† WebAssembly (Pyodide) æŠ€æœ¯ã€‚</p>
        <p>ğŸ”’ <strong>éšç§å®‰å…¨</strong>ï¼šæ‚¨çš„è´¦å•æ–‡ä»¶åªåœ¨æ‚¨çš„æµè§ˆå™¨å†…å¤„ç†ï¼Œ<b>ä¸ä¼š</b>ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
    </div>

    <div class="container">
        <div class="control-group">
            <label for="fileInput">1. é€‰æ‹©å¾®ä¿¡è´¦å• PDF æ–‡ä»¶ (æ”¯æŒå¤šé€‰)</label>
            <input type="file" id="fileInput" accept="application/pdf" multiple disabled>
        </div>

        <div class="control-group">
            <label>2. å¼€å§‹è½¬æ¢</label>
            <button id="convertBtn" onclick="startConversion()" disabled>æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ...</button>
        </div>

        <div class="control-group">
            <label>è¿è¡Œæ—¥å¿—</label>
            <div id="status">æ­£åœ¨ä¸‹è½½ Python è¿è¡Œæ—¶ (çº¦ 10MB)ï¼Œè¯·ç¨å€™...</div>
        </div>
    </div>

    <script type="text/javascript">
        let pyodide = null;
        let micropip = null;
        const statusDiv = document.getElementById("status");
        const convertBtn = document.getElementById("convertBtn");
        const fileInput = document.getElementById("fileInput");

        function log(msg) {
            statusDiv.innerText += msg + "\n";
            statusDiv.scrollTop = statusDiv.scrollHeight;
            console.log(msg);
        }

        async function initPyodideEnv() {
            try {
                pyodide = await loadPyodide();
                log("Python è¿è¡Œæ—¶åŠ è½½æˆåŠŸã€‚");
                
                log("æ­£åœ¨å®‰è£…ä¾èµ–åº“ (micropip, openpyxl, pdfplumber)... è¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚");
                await pyodide.loadPackage("micropip");
                micropip = pyodide.pyimport("micropip");

                // å®‰è£… pandas (openpyxl éœ€è¦) å’Œ xml ç›¸å…³
                // pdfplumber ä¾èµ–: pdfminer.six, pillow, wand(å¯é€‰)
                // Pyodide ç¯å¢ƒä¸­é€šå¸¸è‡ªå¸¦ Pillow
                // ä¸€äº›çº¯ Python åŒ…å¯ä»¥ç›´æ¥é€šè¿‡ micropip.install å®‰è£…
                // æ³¨æ„ï¼šæœ€æ–°ç‰ˆ pdfplumber ä¾èµ– pypdfium2 (å«Cæ‰©å±•ï¼Œä¸æ”¯æŒ Pyodide)ï¼Œå› æ­¤é”å®šä½¿ç”¨æ—§ç‰ˆæœ¬ 0.9.0
                
                await micropip.install(['openpyxl', 'pdfplumber==0.9.0']);
                
                log("ä¾èµ–åº“å®‰è£…å®Œæˆï¼è¯·é€‰æ‹©æ–‡ä»¶è¿›è¡Œè½¬æ¢ã€‚");
                convertBtn.innerText = "å¼€å§‹è½¬æ¢";
                convertBtn.disabled = false;
                fileInput.disabled = false;

                // å®šä¹‰ Python å¤„ç†å‡½æ•°
                pyodide.runPython(`
import datetime
import pdfplumber
import openpyxl
import os

def process_pdfs(file_paths, output_filename):
    print(f"å¼€å§‹å¤„ç† {len(file_paths)} ä¸ªæ–‡ä»¶...")
    try:
        total_rows = []
        for fi, file_path in enumerate(file_paths):
            print(f"æ­£åœ¨è§£æ: {os.path.basename(file_path)}")
            with pdfplumber.open(file_path) as pdf:
                for pi, page in enumerate(pdf.pages):
                    tables = page.extract_tables()
                    for ti, table in enumerate(tables):
                        # å¦‚æœæ˜¯ç¬¬äºŒä¸ªåŠä¹‹åçš„æ–‡ä»¶ï¼Œä¸”æ˜¯ç¬¬ä¸€é¡µç¬¬ä¸€ä¸ªè¡¨ï¼Œé€šå¸¸æ˜¯é‡å¤çš„è¡¨å¤´ä¿¡æ¯ï¼Œéœ€è¦å»æ‰å‰å‡ è¡Œ
                        # åŸé€»è¾‘: if fi != 0 and pi == 0 and ti == 0: table = table[3:] 
                        # è¯·æ³¨æ„ï¼šå¾®ä¿¡è´¦å•æ ¼å¼å¯èƒ½ä¼šæ›´æ–°ï¼Œè¿™é‡Œæ²¿ç”¨åŸè„šæœ¬é€»è¾‘
                        if fi != 0 and pi == 0 and ti == 0:
                            table = table[3:]
                        
                        for row in table:
                            if row and len(row) > 1:
                                # æ¸…ç†æ•°æ®
                                if row[1] and "\\n" in row[1]:
                                    row[1] = row[1].replace("\\n", " ")
                                row = [col.replace("\\n", "") if col else "" for col in row]
                                total_rows.append(row)
        
        if len(total_rows) < 4:
            return False, "è­¦å‘Š: æœªæå–åˆ°è¶³å¤Ÿçš„è¡¨æ ¼æ•°æ®ï¼Œè¯·æ£€æŸ¥ PDF æ˜¯å¦ä¸ºå¾®ä¿¡è´¦å•ã€‚"

        # å¤´éƒ¨å¤§æ¦‚åœ¨ç¬¬3è¡Œ(index 2)ï¼Œæ•°æ®ä»ç¬¬4è¡Œ(index 3)å¼€å§‹ (åŸºäºåŸè„šæœ¬é€»è¾‘)
        # æ³¨æ„: å¦‚æœåªè§£æäº†ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŸé€»è¾‘ä¼šä¿ç•™å‰å‡ è¡Œä½œä¸ºå¤´éƒ¨ä¿¡æ¯æ¥æº
        # total_rows[0:3] åŒ…å«æ ‡é¢˜ã€ç»Ÿè®¡ä¿¡æ¯ç­‰
        
        header = total_rows[2]
        data_rows = total_rows[3:]
        
        # æŒ‰æ—¥æœŸæ’åº (index 1)
        data_rows.sort(key=lambda ele: ele[1])

        wb = openpyxl.Workbook()
        sheet = wb.active
        sheet.title = "è´¦å•"
        
        # å†™è¡¨å¤´
        for ci, col in enumerate(header):
            sheet.cell(row=1, column=ci + 1, value=col)
            
        # å†™æ•°æ®
        for ri, row in enumerate(data_rows):
            for ci, col in enumerate(row):
                cell = sheet.cell(row=ri + 2, column=ci + 1, value=col)
                
                val = col
                if ci == 1:  # æ—¥æœŸåˆ—
                    try:
                        # å°è¯•è§£æç±»ä¼¼äº '2023-01-01 12:00:00'
                        dt = datetime.datetime.fromisoformat(val)
                        cell.value = dt
                        cell.number_format = 'yyyy-mm-dd hh:mm:ss'
                    except:
                        pass
                elif ci == 5:  # é‡‘é¢åˆ—
                    try:
                        f_val = float(val)
                        cell.value = f_val
                        cell.number_format = '0.00'
                    except:
                        pass
        
        wb.save(output_filename)
        return True, f"è½¬æ¢æˆåŠŸ! å…± {len(data_rows)} æ¡è®°å½•ã€‚"
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return False, str(e)
                `);

            } catch (err) {
                log("åˆå§‹åŒ–å¤±è´¥: " + err);
                console.error(err);
            }
        }

        async function startConversion() {
            if (!fileInput.files.length) {
                alert("è¯·å…ˆé€‰æ‹© PDF æ–‡ä»¶ï¼");
                return;
            }

            convertBtn.disabled = true;
            convertBtn.innerText = "å¤„ç†ä¸­...";
            log("å¼€å§‹è¯»å–æ–‡ä»¶...");

            try {
                // 1. å°†ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å†™å…¥ Pyodide è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                let filePaths = [];
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const virtualPath = "/tmp/" + file.name;
                    pyodide.FS.writeFile(virtualPath, uint8Array);
                    filePaths.push(virtualPath);
                }

                log(`å·²åŠ è½½ ${filePaths.length} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨è°ƒç”¨ Python è½¬ç ...`);

                // 2. è°ƒç”¨ Python å‡½æ•°
                const outputFilename = "wechat_bills_export.xlsx";
                // å°† JS æ•°ç»„è½¬æ¢ä¸º Python åˆ—è¡¨
                const processFunc = pyodide.globals.get("process_pdfs");
                const result = processFunc(pyodide.toPy(filePaths), outputFilename);
                const success = result.get(0);
                const msg = result.get(1);

                log(msg);

                if (success) {
                    // 3. å°†ç”Ÿæˆçš„æ–‡ä»¶ä» Pyodide FS è¯»å› JS å¹¶ä¸‹è½½
                    log("æ­£åœ¨å‡†å¤‡ä¸‹è½½...");
                    const fileContent = pyodide.FS.readFile(outputFilename);
                    const blob = new Blob([fileContent], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `å¾®ä¿¡è´¦å•å¯¼å‡º_${new Date().toISOString().slice(0,19).replace(/[-:T]/g,"")}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log("ä¸‹è½½å·²è§¦å‘ã€‚");
                    
                    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    try {
                        pyodide.FS.unlink(outputFilename);
                        filePaths.forEach(p => pyodide.FS.unlink(p));
                    } catch(e) {}
                }

            } catch (err) {
                log("å¤„ç†è¿‡ç¨‹å‡ºé”™: " + err);
                console.error(err);
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerText = "å¼€å§‹è½¬æ¢";
            }
        }

        // å¯åŠ¨åŠ è½½
        initPyodideEnv();

    </script>
</body>
</html>
